---
- hosts: controllers
  vars:
    task_dir: "../tasks"
    files_dir: "../files"
  tasks:
    - include_tasks: "{{ task_dir }}/etcd-install.yaml"

    - name: Load certs and kubeconfigs
      block:
        - name: Create Kubernetes lib directory
          file:
            name: "/var/lib/kubernetes/"
            state: directory

        - name: Copy certs and kubeconfig files to controller
          copy:
            src: "{{ WORK_DIR }}/{{ item }}"
            dest: "/var/lib/kubernetes/"
          loop:
            - ca.pem
            - ca-key.pem
            - kubernetes-key.pem
            - kubernetes.pem
            - service-account-key.pem
            - service-account.pem
            - kube-controller-manager.kubeconfig
            - kube-scheduler.kubeconfig
            - encryption-config.yaml
      become: yes

    - include_tasks: "{{ task_dir }}/kube-apiserver-install.yaml"

    - name: Load config and service files into working directory
      block:
        - name: Load kube-scheduler files
          copy:
            src: "{{ files_dir }}/controller/{{ item }}"
            dest: "{{ WORK_DIR }}/"
          loop:
            - kube-scheduler.yaml
            - kube-scheduler.service
      delegate_to: localhost

    - name: Copy kube-scheduler.yaml
      copy:
        src: "../files/controller/kube-scheduler.yaml"
        dest: "/etc/kubernetes/config/"

    - name: Setup controller services
      include_tasks: "{{ task_dir }}/controller-service-install.yaml"
      loop:
        - name: kube-scheduler
          binary_url: "{{ K8S_RELEASE_BASE_URL }}/kube-scheduler"

