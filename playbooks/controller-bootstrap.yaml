---
- hosts: controllers
  vars:
    tasks_dir: "../tasks"
    files_dir: "../files"
  tasks:
    - include_tasks: "{{ tasks_dir }}/etcd-install.yaml"

    - name: Create Kubernetes directories
      file:
        name: "{{ item }}"
        state: directory
      loop:
        - /var/lib/kubernetes/
        - /etc/kubernetes/config/
      become: yes

    - name: Copy certs, kubeconfigs, service configs to controller
      copy:
        src: "{{ WORK_DIR }}/{{ item.file_name }}"
        dest: "{{ item.file_dest }}"
      loop:
        - {file_name: ca.pem, file_dest: /var/lib/kubernetes}
        - {file_name: ca-key.pem, file_dest: /var/lib/kubernetes}
        - {file_name: kubernetes-key.pem, file_dest: /var/lib/kubernetes}
        - {file_name: kubernetes.pem, file_dest: /var/lib/kubernetes}
        - {file_name: service-account-key.pem, file_dest: /var/lib/kubernetes}
        - {file_name: service-account.pem, file_dest: /var/lib/kubernetes}
        - {file_name: kube-controller-manager.kubeconfig, file_dest: /var/lib/kubernetes}
        - {file_name: kube-scheduler.kubeconfig, file_dest: /var/lib/kubernetes}
        - {file_name: kube-scheduler.yaml, file_dest: /etc/kubernetes/config}
        - {file_name: encryption-config.yaml, file_dest: /var/lib/kubernetes}
      become: yes

    - name: Setup controller services
      include_tasks: "{{ tasks_dir }}/controller-service-install.yaml"
      loop:
        - kube-apiserver
        - kube-scheduler
        - kube-controller-manager
